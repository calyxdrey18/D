<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calyx-Drey Chathub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; background:linear-gradient(120deg,#f5f7fa 0%,#c3cfe2 100%); font-family:'Segoe UI',Arial,sans-serif; overflow:hidden;}
    .cdx-root { width:100vw; height:100vh; max-width:100vw; max-height:100vh; display:flex; flex-direction:column; background:rgba(255,255,255,0.98);}
    .cdx-header { flex-shrink:0; background:#334e68; color:#fff; padding:16px 22px; display:flex; align-items:center; gap:14px; border-bottom-left-radius:18px; border-bottom-right-radius:18px; box-shadow:0 2px 8px #0001; position:relative; z-index:2;}
    .cdx-header .cdx-profile-pic { width:44px; height:44px; border-radius:12px; object-fit:cover; border:2px solid #fff; cursor:pointer; background:#fff;}
    .cdx-header .cdx-title { flex:1; font-size:1.18rem; font-weight:600; letter-spacing:0.5px;}
    .cdx-header .cdx-actions { display:flex; align-items:center; gap:16px;}
    .cdx-header .cdx-actions i { cursor:pointer; font-size:1.35rem; opacity:1; margin-left:0; transition:opacity 0.2s;}
    .cdx-header .cdx-actions i:hover { opacity:0.8;}
    .cdx-online-badge { margin-left:18px; background:#fff; color:#334e68; font-weight:bold; font-size:0.97rem; border-radius:14px; padding:3px 14px; box-shadow:0 1px 4px #0002; letter-spacing:0.5px; display:flex; align-items:center; gap:6px; height:28px; min-width:60px; justify-content:center;}
    .cdx-online-dot { width:10px; height:10px; border-radius:50%; background:#39b385; display:inline-block;}
    .cdx-chat-area { flex:1; background:#f6f8fa; overflow-y:auto; padding:26px 4vw 16px 4vw; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; position:relative; z-index:1;}
    .cdx-message { width:25%; min-width:25%; max-width:25%; display:flex; flex-direction:column; margin-bottom:2px; position:relative; padding-bottom:2px; border-radius:18px 18px 18px 6px; box-shadow:0 1px 5px #0001; background:lavender; align-self:flex-start; animation:fadeInMsg 0.18s; transition:background 0.2s, box-shadow 0.2s; user-select:text; word-break:break-word; overflow-wrap:break-word; white-space:pre-line; border:1.5px solid #d6cde9; margin-left:8px;}
    .cdx-message.sent { align-self:flex-end; border-radius:18px 18px 6px 18px; border:1.5px solid #d6cde9; margin-right:8px; background:lavender;}
    .cdx-message .cdx-sender-row { display:flex; align-items:center; gap:8px; margin:6px 0 2px 14px;}
    .cdx-message .cdx-sender-pic { width:22px; height:22px; border-radius:7px; object-fit:cover; border:1px solid #eee; background:#fff;}
    .cdx-message .cdx-sender { font-size:0.93rem; font-weight:600; color:#6b4e9c;}
    .cdx-message.sent .cdx-sender { color:#4b3a75;}
    .cdx-bubble { padding:11px 16px 7px 16px; font-size:1rem; line-height:1.5; border-radius:16px; background:transparent; position:relative; word-break:break-word; overflow-wrap:break-word; white-space:pre-line;}
    .cdx-meta { font-size:0.75rem; color:#888; margin:0 12px 6px 0; text-align:right; align-self:flex-end;}
    .cdx-message img.cdx-img { margin:6px 0 0 0; max-width:100%; border-radius:10px; box-shadow:0 2px 8px #0002; display:block;}
    .cdx-message .cdx-file-link { color:#6b4e9c; text-decoration:underline; font-size:0.97rem; margin-top:6px; margin-left:16px; display:inline-block; word-break:break-all;}
    .cdx-reply-btn { position:absolute; left:-38px; top:18px; color:#b0a0d1; background:none; border:none; font-size:1.1rem; cursor:pointer; opacity:0; transition:opacity 0.2s; z-index:2;}
    .cdx-message:hover .cdx-reply-btn, .cdx-message:focus-within .cdx-reply-btn { opacity:1;}
    .cdx-message.sent .cdx-reply-btn { left:auto; right:-38px;}
    .cdx-reply-preview { background:#ede7f6; border-left:4px solid #6b4e9c; border-radius:8px; padding:7px 12px; margin-bottom:7px; font-size:0.93rem; color:#4b3a75; display:flex; align-items:center; gap:8px; max-width:95vw; word-break:break-word;}
    .cdx-reply-preview .cdx-reply-close { margin-left:auto; background:none; border:none; color:#888; font-size:1.1rem; cursor:pointer;}
    .cdx-input-bar { background:#f7f7f9; display:flex; align-items:center; padding:13px 4vw; gap:10px; border-top:1px solid #e0e0e0; flex-shrink:0;}
    .cdx-input-bar input[type="text"] { flex:1; padding:12px 16px; border-radius:18px; border:1px solid #d0d0d0; font-size:1rem; outline:none; background:#fff; transition:border 0.2s;}
    .cdx-input-bar input[type="text"]:focus { border-color:#6b4e9c;}
    .cdx-input-bar input[type="file"] { display:none;}
    .cdx-input-bar .cdx-btn { background:none; border:none; font-size:1.3rem; color:#8a75b1; cursor:pointer; margin:0 2px; transition:color 0.2s; border-radius:50%; width:38px; height:38px; display:flex; align-items:center; justify-content:center;}
    .cdx-input-bar .cdx-btn:hover { color:#4b3a75; background:#e6e9f0;}
    .cdx-input-bar .cdx-send-btn { color:#fff; background:#6b4e9c; border-radius:50%; width:42px; height:42px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; margin-left:4px; border:none; cursor:pointer; transition:background 0.2s;}
    .cdx-input-bar .cdx-send-btn:hover { background:#4b3a75;}
    /* Guide popup */
    .cdx-guide-popup-bg { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(60,50,100,0.25); display:flex; align-items:center; justify-content:center; z-index:3000; animation:fadeInBg 0.5s;}
    .cdx-guide-popup { background:#fff; border-radius:20px; box-shadow:0 8px 40px #6b4e9c44; padding:36px 30px 30px 30px; min-width:300px; max-width:96vw; text-align:center; position:relative; transform:scale(0.7); opacity:0; animation:popupIn 0.7s cubic-bezier(.25,1.7,.7,1.2) forwards;}
    .cdx-guide-popup h2 { color:#6b4e9c; font-size:1.5rem; margin-bottom:16px; letter-spacing:1px; font-weight:700;}
    .cdx-guide-popup ul { text-align:left; margin:18px auto 18px auto; padding:0 0 0 18px; color:#4b3a75; font-size:1.09rem; line-height:1.8;}
    .cdx-guide-popup .cdx-guide-btn { margin-top:18px; background:#6b4e9c; color:#fff; border:none; border-radius:10px; padding:10px 32px; font-size:1.08rem; font-weight:600; cursor:pointer; transition:background 0.2s, box-shadow 0.2s; box-shadow:0 2px 8px #6b4e9c22;}
    .cdx-guide-popup .cdx-guide-btn:hover { background:#4b3a75; box-shadow:0 4px 16px #6b4e9c33;}
    .cdx-guide-popup .cdx-guide-emoji { font-size:2.2rem; margin-bottom:8px; display:block; animation:bounce 1.2s infinite alternate;}
    @keyframes fadeInMsg { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
    @keyframes fadeInBg { from{opacity:0;} to{opacity:1;} }
    @keyframes popupIn { 0%{transform:scale(0.7); opacity:0;} 80%{transform:scale(1.07); opacity:1;} 100%{transform:scale(1); opacity:1;} }
    @keyframes bounce { 0%{transform:translateY(0);} 100%{transform:translateY(-12px);} }
    @media (max-width: 700px) {
      .cdx-chat-area, .cdx-input-bar { padding-left: 2vw; padding-right: 2vw; }
      .cdx-video-box video { width: 95vw; }
      .cdx-message { width: 90vw; min-width: 90vw; max-width: 90vw;}
    }
    @media (max-width: 500px) {
      .cdx-header { border-radius: 0; }
      .cdx-chat-area, .cdx-input-bar { padding-left: 1vw; padding-right: 1vw; }
      .cdx-video-box { padding: 10px 2vw;}
      .cdx-video-box video { width: 97vw; }
      .cdx-message { width: 96vw; min-width: 96vw; max-width: 96vw;}
    }
    .cdx-modal-bg { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(40,50,60,0.85); display:flex; align-items:center; justify-content:center; z-index:2000;}
    .cdx-modal { background:#fff; border-radius:16px; padding:32px 20px; box-shadow:0 8px 32px #0006; text-align:center; min-width:280px; max-width:95vw;}
    .cdx-modal h2 { color:#6b4e9c; margin-bottom:18px;}
    .cdx-modal input { padding:12px 18px; font-size:1.1rem; border-radius:8px; border:1px solid #d0d0d0; margin-bottom:18px; width:90%; max-width:270px;}
    .cdx-modal button { background:#6b4e9c; color:#fff; border:none; border-radius:8px; padding:10px 28px; font-size:1rem; cursor:pointer; transition:background 0.2s;}
    .cdx-modal button:hover { background:#4b3a75; }
    .cdx-modal .cdx-error { color:#c00; font-size:0.98rem; margin-bottom:10px;}
    .cdx-modal .cdx-profile-upload { margin-bottom:18px; display:flex; flex-direction:column; align-items:center; gap:7px;}
    .cdx-modal .cdx-profile-preview { width:64px; height:64px; border-radius:10px; object-fit:cover; border:2px solid #6b4e9c; background:#eee; cursor:pointer;}
    .cdx-modal .cdx-profile-upload-label { font-size:0.95rem; color:#6b4e9c; cursor:pointer; text-decoration:underline;}
    .cdx-modal .cdx-color-label { font-size:0.95rem; color:#6b4e9c; margin-top:8px; margin-bottom:4px; display:block;}
    .cdx-modal input[type="color"] { width:36px; height:36px; border:none; background:none; cursor:pointer; vertical-align:middle; margin-bottom:8px;}
  </style>
</head>
<body>
  <!-- Guide Popup -->
  <div class="cdx-guide-popup-bg" id="cdx-guide-popup-bg">
    <div class="cdx-guide-popup" id="cdx-guide-popup">
      <span class="cdx-guide-emoji">ðŸ’¬</span>
      <h2>Welcome to Calyx-Drey Chathub!</h2>
      <ul>
        <li>Pick a unique username and upload your profile picture.</li>
        <li>Type messages and press <b>Enter</b> or the <b>Send</b> button to chat.</li>
        <li>Swipe or click the <i class="fas fa-reply"></i> icon on any message to reply.</li>
        <li>Click <i class="fas fa-paperclip"></i> to share images or files.</li>
        <li>Click <i class="fas fa-video"></i> to start a video call (demo).</li>
        <li>Your chat bubbles are always compact and lavender!</li>
      </ul>
      <button class="cdx-guide-btn" onclick="closeGuidePopup()">Let's Start!</button>
    </div>
  </div>
  <!-- Username Modal -->
  <div class="cdx-modal-bg" id="cdx-username-modal">
    <div class="cdx-modal">
      <h2>Choose a unique username</h2>
      <div class="cdx-profile-upload">
        <img src="https://via.placeholder.com/64x64?text=+" class="cdx-profile-preview" id="cdx-profile-preview" alt="Profile">
        <label class="cdx-profile-upload-label" for="cdx-profile-pic-input">Upload Profile Picture</label>
        <input type="file" id="cdx-profile-pic-input" accept="image/*" style="display:none;">
      </div>
      <label class="cdx-color-label" for="cdx-bubble-color-input">Choose your bubble color</label>
      <input type="color" id="cdx-bubble-color-input" value="#e6e6fa" disabled>
      <div class="cdx-error" id="cdx-username-error"></div>
      <input type="text" id="cdx-username-input" placeholder="Enter username..." maxlength="18" autocomplete="off" />
      <br>
      <button id="cdx-username-btn">Enter Chat</button>
    </div>
  </div>
  <div class="cdx-root">
    <div class="cdx-header">
      <img src="https://via.placeholder.com/44x44?text=+" class="cdx-profile-pic" id="cdx-header-profile-pic" alt="Profile" title="Click to change profile picture">
      <div class="cdx-title">Calyx-Drey Group Chat</div>
      <div class="cdx-actions">
        <i class="fas fa-video" id="cdx-video-btn" title="Video Call"></i>
        <div class="cdx-online-badge" id="cdx-online-badge" style="display:none;">
          <span class="cdx-online-dot"></span>
          <span id="cdx-online-number">1</span> online
        </div>
      </div>
    </div>
    <div class="cdx-chat-area" id="cdx-chat-area"></div>
    <div class="cdx-input-bar" id="cdx-input-bar">
      <button class="cdx-btn" id="emoji-btn" title="Emoji"><i class="far fa-smile"></i></button>
      <button class="cdx-btn" id="attach-btn" title="Attach file"><i class="fas fa-paperclip"></i></button>
      <input type="file" id="cdx-file-input" />
      <input type="text" id="cdx-message-input" placeholder="Type a message..." autocomplete="off" />
      <button class="cdx-send-btn" id="cdx-send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  <!-- Video Modal -->
  <div class="cdx-video-modal" id="cdx-video-modal">
    <div class="cdx-video-box">
      <h2>Video Call</h2>
      <video id="cdx-video" autoplay playsinline muted></video>
      <br>
      <button id="cdx-video-start">Start</button>
      <button id="cdx-video-stop">Stop</button>
      <button id="cdx-video-close">Close</button>
    </div>
  </div>
  <script>
    // Guide popup logic
    function closeGuidePopup() {
      document.getElementById('cdx-guide-popup-bg').style.display = "none";
    }
    // --- Unique username system with profile pic and bubble color ---
    let users = [];
    let myUser = null;
    let messages = [];
    let replyTo = null;
    let myProfilePic = "https://via.placeholder.com/44x44?text=+";
    let myBubbleColor = "#e6e6fa"; // lavender

    // Demo users for uniqueness check (simulate online users)
    let demoUsers = [
      { name: "Alex", color: "#4e6fae", profilePic: "https://i.pravatar.cc/44?img=1", bubbleColor: "#e0f7fa" },
      { name: "Taylor", color: "#b06ab3", profilePic: "https://i.pravatar.cc/44?img=2", bubbleColor: "#ffe0b2" },
      { name: "Jordan", color: "#39b385", profilePic: "https://i.pravatar.cc/44?img=3", bubbleColor: "#e1bee7" }
    ];

    // WebSocket
    let ws;
    function connectWS() {
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
      ws.onopen = () => { if (myUser) ws.send(JSON.stringify({type:'join', username:myUser.name})); };
      ws.onmessage = e => {
        let data = {};
        try { data = JSON.parse(e.data); } catch { return; }
        if (data.type === 'online') {
          document.getElementById('cdx-online-number').textContent = data.count;
        } else if (data.type === 'message') {
          messages.push(data.message);
          renderMessages();
        }
      };
      ws.onclose = () => setTimeout(connectWS, 3000);
    }
    connectWS();

    // Profile picture upload logic (modal)
    document.getElementById('cdx-profile-preview').onclick =
    document.querySelector('.cdx-profile-upload-label').onclick = function() {
      document.getElementById('cdx-profile-pic-input').click();
    };
    document.getElementById('cdx-profile-pic-input').onchange = function() {
      if (!this.files[0]) return;
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('cdx-profile-preview').src = e.target.result;
        myProfilePic = e.target.result;
        document.getElementById('cdx-header-profile-pic').src = e.target.result;
      };
      reader.readAsDataURL(file);
      this.value = '';
    };

    // Change profile pic from header
    document.getElementById('cdx-header-profile-pic').onclick = function() {
      document.getElementById('cdx-profile-pic-input').click();
    };

    // Bubble color picker (locked to lavender)
    document.getElementById('cdx-bubble-color-input').onchange = function() {
      myBubbleColor = "#e6e6fa";
      this.value = "#e6e6fa";
    };

    // Username modal logic
    function showUsernameModal() {
      document.getElementById('cdx-username-modal').style.display = 'flex';
      document.getElementById('cdx-username-input').focus();
    }
    function hideUsernameModal() {
      document.getElementById('cdx-username-modal').style.display = 'none';
    }
    function updateOnlineUsers() {
      users = [myUser, ...demoUsers];
      document.getElementById('cdx-online-badge').style.display = 'flex';
    }
    document.getElementById('cdx-username-btn').onclick = trySetUsername;
    document.getElementById('cdx-username-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') trySetUsername();
    });
    function trySetUsername() {
      const input = document.getElementById('cdx-username-input');
      const error = document.getElementById('cdx-username-error');
      let name = input.value.trim();
      if (!name) { error.textContent = "Please enter a username."; return; }
      if (name.length < 3) { error.textContent = "Username must be at least 3 characters."; return; }
      if ([...demoUsers.map(u=>u.name), myUser?.name].includes(name)) {
        error.textContent = "Username already taken. Choose another.";
        return;
      }
      if (!myProfilePic) myProfilePic = "https://via.placeholder.com/44x44?text=+";
      myUser = { name, color: '#6b4e9c', self: true, profilePic: myProfilePic, bubbleColor: myBubbleColor };
      document.getElementById('cdx-header-profile-pic').src = myProfilePic;
      hideUsernameModal();
      updateOnlineUsers();
      ws.send(JSON.stringify({type:'join', username:myUser.name}));
      messages = [
        { user: demoUsers[0], text: "Welcome to the new group chat!", time: "09:01" },
        { user: demoUsers[1], text: "Hey all! ðŸŽ‰", time: "09:02" },
        { user: myUser, text: "Hi everyone!", time: "09:03" },
        { user: demoUsers[2], text: "Let's share some files!", time: "09:04" }
      ];
      renderMessages();
    }
    // --- Chat logic ---
    function renderMessages() {
      const area = document.getElementById('cdx-chat-area');
      area.innerHTML = '';
      messages.forEach((msg, idx) => area.appendChild(renderMessage(msg, idx)));
      area.scrollTop = area.scrollHeight;
    }
    function renderMessage(msg, idx) {
      const { user, text, file, fileName, time, reply } = msg;
      const div = document.createElement('div');
      div.className = 'cdx-message' + (user.self ? ' sent' : '');
      div.setAttribute('tabindex', '0');
      div.style.setProperty('--bubble-color', "lavender");
      if (reply) {
        div.innerHTML += `<div class="cdx-reply-preview" style="background:#ede7f6;border-left:4px solid ${reply.user.color}">
          <span style="font-weight:600;color:${reply.user.color}">${reply.user.name}:</span>
          <span>${reply.text ? reply.text.slice(0, 40) : '[file]'}</span>
        </div>`;
      }
      div.innerHTML += `<div class="cdx-sender-row">
        <img src="${user.profilePic || 'https://via.placeholder.com/22x22?text=+'}" class="cdx-sender-pic" alt="Profile">
        <span class="cdx-sender" style="color:${user.color}">${user.name}</span>
      </div>`;
      let bubble = `<div class="cdx-bubble">`;
      if (file) {
        if (file.startsWith('data:image')) {
          bubble += `<img src="${file}" class="cdx-img" alt="img"/>`;
        } else {
          bubble += `<a class="cdx-file-link" href="${file}" download="${fileName}">ðŸ“Ž ${fileName}</a>`;
        }
      }
      if (text) bubble += text;
      bubble += `</div>`;
      div.innerHTML += bubble;
      div.innerHTML += `<div class="cdx-meta">${time || new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      // Reply button
      const replyBtn = document.createElement('button');
      replyBtn.className = 'cdx-reply-btn';
      replyBtn.title = "Reply";
      replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
      replyBtn.onclick = e => { e.stopPropagation(); setReplyTo(idx); };
      div.appendChild(replyBtn);

      // Touch swipe-to-reply
      let startX = null, moved = false;
      div.addEventListener('touchstart', e => {
        if (e.touches.length === 1) startX = e.touches[0].clientX;
      });
      div.addEventListener('touchmove', e => {
        if (startX !== null) {
          const dx = e.touches[0].clientX - startX;
          if (!user.self && dx > 40) { moved = true; }
          if (user.self && dx < -40) { moved = true; }
        }
      });
      div.addEventListener('touchend', e => {
        if (moved) setReplyTo(idx);
        startX = null; moved = false;
      });
      return div;
    }
    function setReplyTo(idx) {
      replyTo = messages[idx];
      document.getElementById('cdx-message-input').focus();
    }
    document.getElementById('cdx-send-btn').onclick = sendMessage;
    document.getElementById('cdx-message-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
    function sendMessage() {
      const input = document.getElementById('cdx-message-input');
      const text = input.value.trim();
      if (!text && !replyTo) return;
      const msgObj = {
        user: {...myUser, bubbleColor: "lavender"},
        text,
        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
        reply: replyTo ? { user: replyTo.user, text: replyTo.text } : undefined
      };
      messages.push(msgObj);
      renderMessages();
      input.value = '';
      replyTo = null;
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({type:'message', message:msgObj}));
    }
    document.getElementById('attach-btn').onclick = () => document.getElementById('cdx-file-input').click();
    document.getElementById('cdx-file-input').onchange = function() {
      if (!this.files[0]) return;
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const msgObj = {
          user: {...myUser, bubbleColor: "lavender"},
          file: e.target.result,
          fileName: file.name,
          time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
          reply: replyTo ? { user: replyTo.user, text: replyTo.text } : undefined
        };
        messages.push(msgObj);
        renderMessages();
        replyTo = null;
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({type:'message', message:msgObj}));
      };
      reader.readAsDataURL(file);
      this.value = '';
    };
    document.getElementById('emoji-btn').onclick = () => {
      const input = document.getElementById('cdx-message-input');
      input.value += "ðŸ˜Š";
      input.focus();
    };
    let localStream = null;
    document.getElementById('cdx-video-btn').onclick = () => {
      document.getElementById('cdx-video-modal').classList.add('active');
    };
    document.getElementById('cdx-video-close').onclick = closeVideo;
    document.getElementById('cdx-video-stop').onclick = closeVideo;
    document.getElementById('cdx-video-start').onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('cdx-video').srcObject = localStream;
      } catch (e) {
        alert('Could not access camera/microphone.');
      }
    };
    function closeVideo() {
      document.getElementById('cdx-video-modal').classList.remove('active');
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      document.getElementById('cdx-video').srcObject = null;
    }
    function fitToScreen() {
      document.querySelector('.cdx-root').style.height = window.innerHeight + 'px';
      document.querySelector('.cdx-root').style.width = window.innerWidth + 'px';
    }
    window.addEventListener('resize', fitToScreen);
    fitToScreen();
    window.onload = showUsernameModal;
  </script>
</body>
</html>
