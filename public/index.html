<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calyx-Drey Chathub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ... (same CSS as before, lavender bubbles, guide popup, etc.) ... */
    /* For brevity, use the CSS from the previous answer */
  </style>
</head>
<body>
  <!-- Guide Popup -->
  <div class="cdx-guide-popup-bg" id="cdx-guide-popup-bg">
    <div class="cdx-guide-popup" id="cdx-guide-popup">
      <span class="cdx-guide-emoji">ðŸ’¬</span>
      <h2>Welcome to Calyx-Drey Chathub!</h2>
      <ul>
        <li>Pick a unique username and upload your profile picture.</li>
        <li>Type messages and press <b>Enter</b> or the <b>Send</b> button to chat.</li>
        <li>Swipe or click the <i class="fas fa-reply"></i> icon on any message to reply.</li>
        <li>Click <i class="fas fa-paperclip"></i> to share images or files.</li>
        <li>Click <i class="fas fa-video"></i> to start a video call with another user.</li>
        <li>Your chat bubbles are always compact and lavender!</li>
      </ul>
      <button class="cdx-guide-btn" onclick="closeGuidePopup()">Let's Start!</button>
    </div>
  </div>
  <!-- Username Modal -->
  <div class="cdx-modal-bg" id="cdx-username-modal">
    <div class="cdx-modal">
      <h2>Choose a unique username</h2>
      <div class="cdx-profile-upload">
        <img src="https://via.placeholder.com/64x64?text=+" class="cdx-profile-preview" id="cdx-profile-preview" alt="Profile">
        <label class="cdx-profile-upload-label" for="cdx-profile-pic-input">Upload Profile Picture</label>
        <input type="file" id="cdx-profile-pic-input" accept="image/*" style="display:none;">
      </div>
      <label class="cdx-color-label" for="cdx-bubble-color-input">Your bubble color</label>
      <input type="color" id="cdx-bubble-color-input" value="#e6e6fa" disabled>
      <div class="cdx-error" id="cdx-username-error"></div>
      <input type="text" id="cdx-username-input" placeholder="Enter username..." maxlength="18" autocomplete="off" />
      <br>
      <button id="cdx-username-btn">Enter Chat</button>
    </div>
  </div>
  <div class="cdx-root">
    <div class="cdx-header">
      <img src="https://via.placeholder.com/44x44?text=+" class="cdx-profile-pic" id="cdx-header-profile-pic" alt="Profile" title="Click to change profile picture">
      <div class="cdx-title">Calyx-Drey Group Chat</div>
      <div class="cdx-actions">
        <i class="fas fa-video" id="cdx-video-btn" title="Video Call"></i>
        <div class="cdx-online-badge" id="cdx-online-badge" style="display:none;">
          <span class="cdx-online-dot"></span>
          <span id="cdx-online-number">1</span> online
        </div>
      </div>
    </div>
    <div class="cdx-chat-area" id="cdx-chat-area"></div>
    <div class="cdx-input-bar" id="cdx-input-bar">
      <button class="cdx-btn" id="emoji-btn" title="Emoji"><i class="far fa-smile"></i></button>
      <button class="cdx-btn" id="attach-btn" title="Attach file"><i class="fas fa-paperclip"></i></button>
      <input type="file" id="cdx-file-input" />
      <input type="text" id="cdx-message-input" placeholder="Type a message..." autocomplete="off" />
      <button class="cdx-send-btn" id="cdx-send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  <!-- Video Modal -->
  <div class="cdx-video-modal" id="cdx-video-modal">
    <div class="cdx-video-box">
      <h2>Video Call</h2>
      <video id="cdx-local-video" autoplay playsinline muted style="background:#222; border-radius:8px; width:90%;"></video>
      <video id="cdx-remote-video" autoplay playsinline style="background:#222; border-radius:8px; width:90%; margin-top:10px;"></video>
      <br>
      <button id="cdx-video-call-btn">Call</button>
      <button id="cdx-video-hangup-btn">Hang Up</button>
      <button id="cdx-video-close">Close</button>
      <div id="cdx-video-status" style="margin-top:8px; color:#6b4e9c;"></div>
    </div>
  </div>
  <script>
    // Guide popup logic
    function closeGuidePopup() {
      document.getElementById('cdx-guide-popup-bg').style.display = "none";
    }
    // --- Unique username system with profile pic and bubble color ---
    let users = [];
    let myUser = null;
    let messages = [];
    let replyTo = null;
    let myProfilePic = "https://via.placeholder.com/44x44?text=+";
    let myBubbleColor = "#e6e6fa"; // lavender

    // WebSocket
    let ws;
    function connectWS() {
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
      ws.onopen = () => { if (myUser) ws.send(JSON.stringify({type:'join', username:myUser.name})); };
      ws.onmessage = e => {
        let data = {};
        try { data = JSON.parse(e.data); } catch { return; }
        if (data.type === 'online') {
          document.getElementById('cdx-online-number').textContent = data.count;
        } else if (data.type === 'history') {
          messages = data.messages || [];
          renderMessages();
        } else if (data.type === 'message') {
          messages.push(data.message);
          renderMessages();
        } else if (data.type === 'signal') {
          handleSignal(data);
        }
      };
      ws.onclose = () => setTimeout(connectWS, 3000);
    }
    connectWS();

    // Profile picture upload logic (modal)
    document.getElementById('cdx-profile-preview').onclick =
    document.querySelector('.cdx-profile-upload-label').onclick = function() {
      document.getElementById('cdx-profile-pic-input').click();
    };
    document.getElementById('cdx-profile-pic-input').onchange = function() {
      if (!this.files[0]) return;
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('cdx-profile-preview').src = e.target.result;
        myProfilePic = e.target.result;
        document.getElementById('cdx-header-profile-pic').src = e.target.result;
      };
      reader.readAsDataURL(file);
      this.value = '';
    };

    document.getElementById('cdx-header-profile-pic').onclick = function() {
      document.getElementById('cdx-profile-pic-input').click();
    };

    document.getElementById('cdx-bubble-color-input').onchange = function() {
      myBubbleColor = "#e6e6fa";
      this.value = "#e6e6fa";
    };

    function showUsernameModal() {
      document.getElementById('cdx-username-modal').style.display = 'flex';
      document.getElementById('cdx-username-input').focus();
    }
    function hideUsernameModal() {
      document.getElementById('cdx-username-modal').style.display = 'none';
    }
    function updateOnlineUsers() {
      document.getElementById('cdx-online-badge').style.display = 'flex';
    }
    document.getElementById('cdx-username-btn').onclick = trySetUsername;
    document.getElementById('cdx-username-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') trySetUsername();
    });
    function trySetUsername() {
      const input = document.getElementById('cdx-username-input');
      const error = document.getElementById('cdx-username-error');
      let name = input.value.trim();
      if (!name) { error.textContent = "Please enter a username."; return; }
      if (name.length < 3) { error.textContent = "Username must be at least 3 characters."; return; }
      if (myUser && myUser.name === name) { error.textContent = "Username already taken. Choose another."; return; }
      if (!myProfilePic) myProfilePic = "https://via.placeholder.com/44x44?text=+";
      myUser = { name, color: '#6b4e9c', self: true, profilePic: myProfilePic, bubbleColor: myBubbleColor };
      document.getElementById('cdx-header-profile-pic').src = myProfilePic;
      hideUsernameModal();
      updateOnlineUsers();
      ws.send(JSON.stringify({type:'join', username:myUser.name}));
    }
    function renderMessages() {
      const area = document.getElementById('cdx-chat-area');
      area.innerHTML = '';
      messages.forEach((msg, idx) => area.appendChild(renderMessage(msg, idx)));
      area.scrollTop = area.scrollHeight;
    }
    function renderMessage(msg, idx) {
      const { user, text, file, fileName, time, reply } = msg;
      const div = document.createElement('div');
      div.className = 'cdx-message' + (user.name === (myUser && myUser.name) ? ' sent' : '');
      div.setAttribute('tabindex', '0');
      div.style.setProperty('--bubble-color', "lavender");
      if (reply) {
        div.innerHTML += `<div class="cdx-reply-preview" style="background:#ede7f6;border-left:4px solid ${reply.user.color}">
          <span style="font-weight:600;color:${reply.user.color}">${reply.user.name}:</span>
          <span>${reply.text ? reply.text.slice(0, 40) : '[file]'}</span>
        </div>`;
      }
      div.innerHTML += `<div class="cdx-sender-row">
        <img src="${user.profilePic || 'https://via.placeholder.com/22x22?text=+'}" class="cdx-sender-pic" alt="Profile">
        <span class="cdx-sender" style="color:${user.color}">${user.name}</span>
      </div>`;
      let bubble = `<div class="cdx-bubble">`;
      if (file) {
        if (file.startsWith('data:image')) {
          bubble += `<img src="${file}" class="cdx-img" alt="img"/>`;
        } else {
          bubble += `<a class="cdx-file-link" href="${file}" download="${fileName}">ðŸ“Ž ${fileName}</a>`;
        }
      }
      if (text) bubble += text;
      bubble += `</div>`;
      div.innerHTML += bubble;
      div.innerHTML += `<div class="cdx-meta">${time || new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      const replyBtn = document.createElement('button');
      replyBtn.className = 'cdx-reply-btn';
      replyBtn.title = "Reply";
      replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
      replyBtn.onclick = e => { e.stopPropagation(); setReplyTo(idx); };
      div.appendChild(replyBtn);
      let startX = null, moved = false;
      div.addEventListener('touchstart', e => { if (e.touches.length === 1) startX = e.touches[0].clientX; });
      div.addEventListener('touchmove', e => {
        if (startX !== null) {
          const dx = e.touches[0].clientX - startX;
          if (user.name !== (myUser && myUser.name) && dx > 40) { moved = true; }
          if (user.name === (myUser && myUser.name) && dx < -40) { moved = true; }
        }
      });
      div.addEventListener('touchend', e => { if (moved) setReplyTo(idx); startX = null; moved = false; });
      return div;
    }
    function setReplyTo(idx) {
      replyTo = messages[idx];
      document.getElementById('cdx-message-input').focus();
    }
    document.getElementById('cdx-send-btn').onclick = sendMessage;
    document.getElementById('cdx-message-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
    function sendMessage() {
      const input = document.getElementById('cdx-message-input');
      const text = input.value.trim();
      if (!text && !replyTo) return;
      const msgObj = {
        user: {...myUser, bubbleColor: "lavender"},
        text,
        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
        reply: replyTo ? { user: replyTo.user, text: replyTo.text } : undefined
      };
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({type:'message', message:msgObj}));
      input.value = '';
      replyTo = null;
    }
    document.getElementById('attach-btn').onclick = () => document.getElementById('cdx-file-input').click();
    document.getElementById('cdx-file-input').onchange = function() {
      if (!this.files[0]) return;
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const msgObj = {
          user: {...myUser, bubbleColor: "lavender"},
          file: e.target.result,
          fileName: file.name,
          time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
          reply: replyTo ? { user: replyTo.user, text: replyTo.text } : undefined
        };
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({type:'message', message:msgObj}));
        replyTo = null;
      };
      reader.readAsDataURL(file);
      this.value = '';
    };
    document.getElementById('emoji-btn').onclick = () => {
      const input = document.getElementById('cdx-message-input');
      input.value += "ðŸ˜Š";
      input.focus();
    };

    // --- WebRTC Video Call (one-to-one, basic demo) ---
    let localStream, remoteStream, pc;
    let isCalling = false;
    document.getElementById('cdx-video-btn').onclick = () => {
      document.getElementById('cdx-video-modal').classList.add('active');
      document.getElementById('cdx-video-status').textContent = '';
    };
    document.getElementById('cdx-video-close').onclick = hangupCall;
    document.getElementById('cdx-video-hangup-btn').onclick = hangupCall;
    document.getElementById('cdx-video-call-btn').onclick = startCall;

    async function startCall() {
      if (isCalling) return;
      isCalling = true;
      document.getElementById('cdx-video-status').textContent = 'Calling...';
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('cdx-local-video').srcObject = localStream;
      pc = createPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'signal', target: null, signal: { offer: offer } }));
    }
    function hangupCall() {
      document.getElementById('cdx-video-modal').classList.remove('active');
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (remoteStream) { remoteStream.getTracks().forEach(t => t.stop()); remoteStream = null; }
      if (pc) { pc.close(); pc = null; }
      document.getElementById('cdx-local-video').srcObject = null;
      document.getElementById('cdx-remote-video').srcObject = null;
      isCalling = false;
      document.getElementById('cdx-video-status').textContent = '';
    }
    function createPeerConnection() {
      const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
      const peer = new RTCPeerConnection(config);
      peer.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify({ type: 'signal', target: null, signal: { candidate: e.candidate } }));
      };
      peer.ontrack = e => {
        if (!remoteStream) {
          remoteStream = new MediaStream();
          document.getElementById('cdx-remote-video').srcObject = remoteStream;
        }
        remoteStream.addTrack(e.track);
      };
      return peer;
    }
    async function handleSignal(data) {
      if (!pc) {
        pc = createPeerConnection();
      }
      if (data.signal.offer) {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('cdx-local-video').srcObject = localStream;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: 'signal', target: data.from, signal: { answer: answer } }));
        document.getElementById('cdx-video-modal').classList.add('active');
        document.getElementById('cdx-video-status').textContent = 'In call...';
      }
      if (data.signal.answer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.answer));
        document.getElementById('cdx-video-status').textContent = 'In call...';
      }
      if (data.signal.candidate) {
        try { await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate)); } catch {}
      }
    }
    function fitToScreen() {
      document.querySelector('.cdx-root').style.height = window.innerHeight + 'px';
      document.querySelector('.cdx-root').style.width = window.innerWidth + 'px';
    }
    window.addEventListener('resize', fitToScreen);
    fitToScreen();
    window.onload = showUsernameModal;
  </script>
</body>
</html>
